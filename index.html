<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マルバツゲーム</title>
<style>
:root[data-theme="light"] {
  --bg:#fff;
  --text:#000;
  --btn:#eee;
  --btn-hover:#ddd;
}
:root[data-theme="dark"] {
  --bg:#222;
  --text:#eee;
  --btn:#444;
  --btn-hover:#555;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  margin:20px;
  transition: background-color .5s,color .5s;
  filter: brightness(100%);
  user-select:none;
}
button {
  background: var(--btn);
  border: 1px solid #999;
  color: var(--text);
  padding: 8px 16px;
  margin: 5px;
  cursor: pointer;
  transition: background-color .3s;
  font-size: 1rem;
  border-radius: 4px;
}
button:hover {
  background: var(--btn-hover);
}
#board {
  display: grid;
  grid-template-columns: repeat(3,80px);
  grid-template-rows: repeat(3,80px);
  gap: 5px;
  margin: 20px auto;
  max-width: 260px;
  user-select:none;
}
.cell {
  background: var(--btn);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
  transition: background-color .3s;
  user-select:none;
}
.cell:hover {
  background: var(--btn-hover);
}
.win-line {
  animation: glow 1.5s ease-in-out infinite;
  border: 3px solid gold;
  box-shadow: 0 0 15px 3px gold;
  border-radius: 8px;
}
@keyframes glow {
  0%,100% { box-shadow: 0 0 10px gold; }
  50% { box-shadow: 0 0 25px gold; }
}
#status {
  font-size: 1.2rem;
  margin-top: 10px;
  min-height: 1.5em;
  user-select:none;
}
#settings {
  border: 1px solid #999;
  padding: 15px;
  max-width: 300px;
  margin: 20px auto;
  border-radius: 8px;
  background: var(--btn);
  user-select:none;
}
#settings label {
  display: block;
  margin-bottom: 12px;
  font-weight: 600;
  user-select:none;
}
#settings input[type="range"] {
  width: 100%;
}
#settings select {
  width: 100%;
  padding: 6px;
  font-size: 1rem;
  border-radius: 4px;
  border: 1px solid #888;
  background: var(--bg);
  color: var(--text);
}
#winStreakDisplay {
  margin-top: 15px;
  font-weight: 700;
  font-size: 1.1rem;
  text-align: center;
  user-select:none;
}
</style>
</head>
<body>
<h1>マルバツゲーム</h1>
<div id="board">
  <div class="cell" data-index="0"></div>
  <div class="cell" data-index="1"></div>
  <div class="cell" data-index="2"></div>
  <div class="cell" data-index="3"></div>
  <div class="cell" data-index="4"></div>
  <div class="cell" data-index="5"></div>
  <div class="cell" data-index="6"></div>
  <div class="cell" data-index="7"></div>
  <div class="cell" data-index="8"></div>
</div>
<div id="status">Xの番です</div>
<button id="resetBtn">リセット</button>
<div id="winStreakDisplay">連勝記録: 0</div>
<div id="settings">
  <h3>設定</h3>
  <label>明るさ:
    <input type="range" id="brightness" min="50" max="150" value="100" />
  </label>
  <label>音量:
    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5" />
  </label>
  <label>テーマ:
    <select id="themeSelect">
      <option value="light">ライト</option>
      <option value="dark">ダーク</option>
      <option value="system" selected>システム</option>
    </select>
  </label>
  <button id="toggleBgm">BGM 再生</button>
</div>
<audio id="bgm" loop preload="auto" src="https://cdn.jsdelivr.net/gh/jackzhenguo/music@master/tetris.mp3"></audio>
<script>
(() => {
  const board = document.getElementById("board");
  const cells = board.querySelectorAll(".cell");
  const status = document.getElementById("status");
  const resetBtn = document.getElementById("resetBtn");
  const winStreakDisplay = document.getElementById("winStreakDisplay");

  let turn = "X";
  let boardState = Array(9).fill(null);
  let gameOver = false;

  let winStreak = parseInt(localStorage.getItem("winStreak")||"0");
  updateWinStreakDisplay();

  function updateWinStreakDisplay() {
    winStreakDisplay.textContent = `連勝記録: ${winStreak}`;
  }

  const winPatterns = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  function checkWin(player){
    return winPatterns.find(p=>p.every(i=>boardState[i]===player));
  }
  function checkDraw(){
    return boardState.every(c=>c!==null);
  }
  function handleClick(e){
    if(gameOver)return;
    const idx=+e.target.dataset.index;
    if(boardState[idx]!==null)return;

    boardState[idx]=turn;
    e.target.textContent=turn;

    const winLine=checkWin(turn);
    if(winLine){
      gameOver=true;
      status.textContent = `${turn} の勝利！`;
      winLine.forEach(i=>cells[i].classList.add("win-line"));
      onWin();
      return;
    }
    if(checkDraw()){
      gameOver=true;
      status.textContent=`引き分け！`;
      onLose();
      return;
    }
    turn = turn==="X"?"O":"X";
    status.textContent = `${turn} の番です`;
  }
  function clearBoard(){
    boardState.fill(null);
    cells.forEach(c=>{
      c.textContent="";
      c.classList.remove("win-line");
    });
    gameOver=false;
    turn="X";
    status.textContent = `${turn} の番です`;
  }
  resetBtn.addEventListener("click",clearBoard);
  cells.forEach(c=>c.addEventListener("click",handleClick));

  function onWin(){
    winStreak++;
    localStorage.setItem("winStreak",winStreak);
    updateWinStreakDisplay();
    playVictoryEffect();
  }
  function onLose(){
    winStreak=0;
    localStorage.setItem("winStreak",winStreak);
    updateWinStreakDisplay();
  }
  function playVictoryEffect(){
    const flash=document.createElement("div");
    flash.style.position="fixed";
    flash.style.top=0;
    flash.style.left=0;
    flash.style.width="100vw";
    flash.style.height="100vh";
    flash.style.backgroundColor="gold";
    flash.style.opacity="0.6";
    flash.style.pointerEvents="none";
    flash.style.zIndex="9999";
    document.body.appendChild(flash);
    setTimeout(()=>flash.remove(),300);
  }

  const bgm=document.getElementById("bgm");
  const toggleBgmBtn=document.getElementById("toggleBgm");
  const brightnessInput=document.getElementById("brightness");
  const volumeInput=document.getElementById("volume");
  const themeSelect=document.getElementById("themeSelect");

  brightnessInput.value=100;
  volumeInput.value=0.5;
  bgm.volume=0.5;

  brightnessInput.addEventListener("input",e=>{
    document.body.style.filter=`brightness(${e.target.value}%)`;
  });
  volumeInput.addEventListener("input",e=>{
    bgm.volume=e.target.value;
  });
  themeSelect.addEventListener("change",e=>{
    const val=e.target.value;
    if(val==="light"){
      document.documentElement.setAttribute("data-theme","light");
    }else if(val==="dark"){
      document.documentElement.setAttribute("data-theme","dark");
    }else{
      document.documentElement.removeAttribute("data-theme");
    }
  });
  let isPlaying=false;
  toggleBgmBtn.addEventListener("click",()=>{
    if(isPlaying){
      bgm.pause();
      toggleBgmBtn.textContent="BGM 再生";
    }else{
      bgm.play();
      toggleBgmBtn.textContent="BGM 停止";
    }
    isPlaying=!isPlaying;
  });
  document.body.addEventListener("click",()=>{
    if(!isPlaying){
      bgm.play().catch(()=>{});
      toggleBgmBtn.textContent="BGM 停止";
      isPlaying=true;
    }
  },{once:true});
})();
</script>
</body>
</html>