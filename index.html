<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マルバツゲーム</title>
<style>
  :root {
    --bg-light: #fff;
    --bg-dark: #222;
    --fg-light: #222;
    --fg-dark: #eee;
    --accent: #f90;
  }
  html[data-theme='light'] {
    background: var(--bg-light);
    color: var(--fg-light);
  }
  html[data-theme='dark'] {
    background: var(--bg-dark);
    color: var(--fg-dark);
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    align-items: center; min-height: 100vh;
  }
  h1 {
    margin: 1rem 0;
  }
  #game {
    display: grid;
    grid-template-columns: repeat(3, 80px);
    grid-template-rows: repeat(3, 80px);
    gap: 6px;
    margin-bottom: 1rem;
  }
  .cell {
    background: #ccc;
    border: 2px solid #999;
    font-size: 48px;
    font-weight: bold;
    text-align: center;
    line-height: 80px;
    cursor: pointer;
    user-select: none;
    border-radius: 6px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  html[data-theme='light'] .cell {
    background: #eee;
    border-color: #bbb;
  }
  html[data-theme='dark'] .cell {
    background: #333;
    border-color: #666;
    color: var(--fg-dark);
  }
  .cell.disabled {
    cursor: default;
    opacity: 0.6;
  }
  #status {
    margin-bottom: 1rem;
    font-size: 1.2rem;
  }
  #streak {
    margin-bottom: 1rem;
    font-weight: bold;
  }
  #resetBtn {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    background: var(--accent);
    color: #fff;
    transition: background-color 0.3s;
  }
  #resetBtn:hover {
    background: #e67e00;
  }
  #menuToggle {
    position: fixed;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    z-index: 100;
  }
  #menuToggle div {
    background: var(--accent);
    height: 4px;
    margin: 6px 0;
    border-radius: 2px;
    transition: 0.3s;
  }
  #menuCheckbox {
    display: none;
  }
  #settingsPanel {
    position: fixed;
    top: 56px;
    right: 16px;
    background: var(--bg-light);
    border: 2px solid var(--accent);
    border-radius: 8px;
    padding: 1rem;
    width: 200px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: none;
    z-index: 99;
  }
  html[data-theme='dark'] #settingsPanel {
    background: var(--bg-dark);
    border-color: var(--accent);
    color: var(--fg-dark);
  }
  #menuCheckbox:checked + #menuToggle + #settingsPanel {
    display: block;
  }
  #settingsPanel label {
    display: block;
    margin: 0.5rem 0 0.25rem;
  }
  #settingsPanel select,
  #settingsPanel input[type=range] {
    width: 100%;
  }
</style>
</head>
<body>
<h1>マルバツゲーム</h1>
<div id="status" role="status" aria-live="polite">あなたの番です。</div>
<div id="streak">連勝記録: 0 連勝</div>
<div id="game" role="grid" aria-label="三目並べ盤面">
  <div class="cell" role="gridcell" tabindex="0" data-index="0" aria-label="セル 1"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="1" aria-label="セル 2"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="2" aria-label="セル 3"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="3" aria-label="セル 4"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="4" aria-label="セル 5"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="5" aria-label="セル 6"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="6" aria-label="セル 7"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="7" aria-label="セル 8"></div>
  <div class="cell" role="gridcell" tabindex="0" data-index="8" aria-label="セル 9"></div>
</div>
<button id="resetBtn" aria-label="ゲームをリセット">リセット</button>

<input type="checkbox" id="menuCheckbox" aria-haspopup="true" aria-controls="settingsPanel" aria-expanded="false" />
<label for="menuCheckbox" id="menuToggle" aria-label="設定メニューを開く">
  <div></div>
  <div></div>
  <div></div>
</label>
<section id="settingsPanel" role="region" aria-labelledby="settingsLabel" tabindex="-1">
  <h2 id="settingsLabel">設定</h2>
  <label for="brightnessRange">明るさ</label>
  <input type="range" id="brightnessRange" min="50" max="150" value="100" />
  <label for="volumeRange">音量</label>
  <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.5" />
  <label for="themeSelect">テーマ</label>
  <select id="themeSelect" aria-label="テーマ選択">
    <option value="system">システム</option>
    <option value="light">ライト</option>
    <option value="dark">ダーク</option>
  </select>
  <button id="resetStreakBtn" style="margin-top:1rem;">連勝記録をリセット</button>
</section>

<audio id="bgm" loop preload="auto" src="https://cdn.jsdelivr.net/gh/kumajoi/tetris-theme-loop@latest/tetris-theme-loop.mp3"></audio>

<script>
(() => {
  const cells = [...document.querySelectorAll('.cell')];
  const status = document.getElementById('status');
  const streakDisplay = document.getElementById('streak');
  const resetGameBtn = document.getElementById('resetBtn');
  const resetStreakBtn = document.getElementById('resetStreakBtn');
  const menuCheckbox = document.getElementById('menuCheckbox');
  const settingsPanel = document.getElementById('settingsPanel');
  const brightnessRange = document.getElementById('brightnessRange');
  const volumeRange = document.getElementById('volumeRange');
  const themeSelect = document.getElementById('themeSelect');
  const bgm = document.getElementById('bgm');

  let boardState = Array(9).fill(null);
  let currentPlayer = 'X';
  let gameActive = true;
  let streakCount = Number(localStorage.getItem('tictactoe_streak')) || 0;

  updateStreak();

  function updateCell(index) {
    cells[index].textContent = boardState[index] || '';
  }

  function checkWin(player) {
    const wins = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];
    return wins.some(line =>
      line.every(index => boardState[index] === player)
    );
  }

  function disableAllCells() {
    cells.forEach(cell => {
      cell.classList.add('disabled');
      cell.setAttribute('aria-disabled', 'true');
      cell.tabIndex = -1;
    });
  }

  function enableAllCells() {
    cells.forEach(cell => {
      cell.classList.remove('disabled');
      cell.removeAttribute('aria-disabled');
      cell.tabIndex = 0;
    });
  }

  function updateStreak() {
    streakDisplay.textContent = `連勝記録: ${streakCount} 連勝`;
  }

  function saveStreak() {
    localStorage.setItem('tictactoe_streak', streakCount);
  }

  function aiMove() {
    const emptyIndices = boardState.map((v,i) => v === null ? i : null).filter(i => i !== null);
    if(emptyIndices.length === 0) return;
    // 簡単なランダムAI
    const choice = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
    boardState[choice] = 'O';
    updateCell(choice);
    if(checkWin('O')) {
      gameActive = false;
      status.textContent = 'AIの勝利です。';
      streakCount = 0;
      updateStreak();
      saveStreak();
      disableAllCells();
      return;
    }
    if(boardState.every(v => v !== null)) {
      gameActive = false;
      status.textContent = '引き分けです。';
      streakCount = 0;
      updateStreak();
      saveStreak();
      return;
    }
    currentPlayer = 'X';
    status.textContent = 'あなたの番です。';
  }

  function onCellClick(e) {
    const index = Number(e.target.dataset.index);
    if(!gameActive || boardState[index] !== null) return;
    boardState[index] = currentPlayer;
    updateCell(index);

    if(checkWin(currentPlayer)) {
      gameActive = false;
      status.textContent = 'あなたの勝利！';
      streakCount++;
      updateStreak();
      saveStreak();
      disableAllCells();
      return;
    }
    if(boardState.every(v => v !== null)) {
      gameActive = false;
      status.textContent = '引き分けです。';
      streakCount = 0;
      updateStreak();
      saveStreak();
      return;
    }
    currentPlayer = 'O';
    status.textContent = 'AIの番です...';
    disableAllCells();
    setTimeout(() => {
      aiMove();
      if(gameActive) enableAllCells();
    }, 500);
  }

  function resetGame() {
    boardState.fill(null);
    currentPlayer = 'X';
    gameActive = true;
    status.textContent = 'あなたの番です。';
    cells.forEach((cell) => {
      cell.textContent = '';
      cell.classList.remove('disabled');
      cell.removeAttribute('aria-disabled');
      cell.tabIndex = 0;
    });
  }

  function resetStreak() {
    streakCount = 0;
    updateStreak();
    saveStreak();
  }

  cells.forEach(cell => {
    cell.addEventListener('click', onCellClick);
    cell.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        cell.click();
      }
    });
  });

  resetGameBtn.addEventListener('click', resetGame);
  resetStreakBtn.addEventListener('click', resetStreak);

  menuCheckbox.addEventListener('change', e => {
    const expanded = e.target.checked;
    e.target.setAttribute('aria-expanded', expanded);
    if(expanded) {
      settingsPanel.focus();
    }
  });

  brightnessRange.addEventListener('input', e => {
    const val = e.target.value;
    document.documentElement.style.filter = `brightness(${val}%)`;
  });

  volumeRange.addEventListener('input', e => {
    bgm.volume = e.target.value;
    if(bgm.volume > 0) {
      bgm.play().catch(()=>{});
    } else {
      bgm.pause();
    }
  });

  themeSelect.value = localStorage.getItem('tictactoe_theme') || 'system';

  function applyTheme(value) {
    if(value === 'system') {
      document.documentElement.removeAttribute('data-theme');
    } else {
      document.documentElement.setAttribute('data-theme', value);
    }
  }
  applyTheme(themeSelect.value);

  themeSelect.addEventListener('change', e => {
    const val = e.target.value;
    localStorage.setItem('tictactoe_theme', val);
    applyTheme(val);
  });

  // 初期設定
  resetGame();
  bgm.volume = volumeRange.value;
  if(bgm.volume > 0) bgm.play().catch(()=>{});

})();
</script>
</body>
</html>